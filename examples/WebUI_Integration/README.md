# WebUI Integration Example

This example demonstrates how to integrate `GitFirmwareUpdate` with the WebUI using the `PulseFanSyncWebUi` library.

## Overview

The example shows:
- How to use `PulseFanSyncWebUi` to serve the WebUI HTML (embedded as PROGMEM)
- How to integrate `GitFirmwareUpdate` with the WebUI via `FirmwareUpdateIntegration`
- How to inject JavaScript callbacks for firmware update
- Integration with WiFiManager (optional)

## Setup Instructions

### 1. Install Required Libraries

Make sure you have installed:
- `GitFirmwareUpdate` (this library)
- `PulseFanSyncWebUi` (WebUI library with embedded HTML)

### 2. Configure Firmware Update

Edit `WebUI_Integration.ino` and update:

```cpp
#define FW_CURRENT_VERSION "1.0.0"  // Your current firmware version
const char* GITHUB_LATEST_URL = 
  "https://raw.githubusercontent.com/yourusername/yourrepo/main/firmware/latest.json";
```

### 3. Configure WiFi

**Option A: Hardcoded credentials**
```cpp
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";
```

**Option B: WiFiManager (recommended)**
1. Uncomment the WiFiManager includes
2. Uncomment the WiFiManager setup code
3. The device will create a captive portal on first boot

### 4. Upload and Test

1. Upload the sketch to your ESP32
2. Connect to WiFi (or use WiFiManager portal)
3. Open `http://esp32-setup.local` or the device IP in your browser
4. Click "Update Firmware" button to test the integration

## How It Works

### HTML Embedding

The HTML is embedded in the `PulseFanSyncWebUi` library as PROGMEM:
- HTML is stored in flash memory (PROGMEM) in the library
- No need to generate `webui_html.h` manually
- Saves ~400KB of RAM

### JavaScript Integration

The `FirmwareUpdateIntegration` class automatically generates JavaScript functions:

```javascript
window.searchFirmware()           // Check for updates
window.startFirmwareDownload()    // Start download
window.startFirmwareInstallation() // Start installation
window.abortUpdate()              // Abort update
```

These functions are generated by `FirmwareUpdateIntegration::generateJavaScriptFunctions()`.

### Progress Reporting

During firmware download:
- Progress is reported via polling `/api/firmware/progress`
- JavaScript calls `window.onFirmwareDownloadProgress(percent)`
- WebServer stays responsive (compatible with WiFiManager)

## Architecture

```
┌─────────────────────┐
│  PulseFanSyncWebUi  │  ← Owns WebServer, serves HTML
└──────────┬──────────┘
           │
           │ getServer()
           ▼
┌─────────────────────┐
│ FirmwareUpdate      │  ← Bridges GitFirmwareUpdate
│ Integration         │     with WebUI JavaScript
└──────────┬──────────┘
           │
           │ uses
           ▼
┌─────────────────────┐
│ GitFirmwareUpdate   │  ← Core firmware update logic
└─────────────────────┘
```

## Code Structure

```cpp
// Create WebUI instance (owns WebServer)
PulseFanSyncWebUi webUI;

// Create firmware update instances
GitFirmwareUpdate fwUpdate(FW_CURRENT_VERSION, GITHUB_LATEST_URL);
FirmwareUpdateIntegration fwUpdateIntegration(webUI.getServer(), fwUpdate);

void setup() {
  // ... WiFi setup ...
  
  // Initialize WebUI
  webUI.begin("esp32-setup");
  
  // Register firmware update integration
  webUI.registerFirmwareUpdateIntegration(&fwUpdateIntegration);
  
  // Inject firmware version
  webUI.injectFirmwareVersion(FW_CURRENT_VERSION);
  
  // Register routes
  webUI.getServer().on("/", [&]() { webUI.handleRoot(); });
}

void loop() {
  webUI.handleClient();  // Handles all WebServer requests
}
```

## Troubleshooting

### HTML not loading
- Make sure `PulseFanSyncWebUi` library is installed correctly
- Check that `webUI.begin()` is called in `setup()`
- Verify the library's `webui_html.h` file exists

### JavaScript functions not working
- Check browser console for errors
- Verify JavaScript injection is happening (view page source)
- Ensure `webUI.registerFirmwareUpdateIntegration()` is called

### WiFiManager not working
- Make sure WiFiManager library is installed
- Uncomment all WiFiManager-related code
- Check Serial output for connection status

## Memory Usage

- **HTML size**: ~400KB (stored in PROGMEM/flash in PulseFanSyncWebUi library)
- **RAM usage**: Minimal (HTML loaded only when serving)
- **Flash usage**: ~500KB total (including HTML)

Make sure your ESP32 has enough flash memory (recommended: 4MB or more).

## Migration from GitFirmwareUpdateWebServer

If you were using the old `GitFirmwareUpdateWebServer` approach:

**Before:**
```cpp
#include <GitFirmwareUpdateWebServer.h>
WebServer server(80);
GitFirmwareUpdateWebServer fwUpdateWeb(server, fwUpdate);
#include "webui_html.h"
void handleRoot() { /* manual HTML serving */ }
```

**After:**
```cpp
#include <PulseFanSyncWebUi.h>
#include "integrations/FirmwareUpdateIntegration.h"
PulseFanSyncWebUi webUI;
FirmwareUpdateIntegration fwUpdateIntegration(webUI.getServer(), fwUpdate);
// No manual HTML serving needed
```

## Next Steps

After testing this example, you can:
1. Add other integrations (BLE sensors, fan control) using `PulseFanSyncWebUi`
2. Customize the HTML by updating `PulseFanSyncWebUi` library
3. Add additional API endpoints via `webUI.getServer()`
4. Deploy to production
